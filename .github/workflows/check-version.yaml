name: Check Version Update

on: [push, pull_request]

jobs:
  check-version-update:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        value:
          [
            'bonds',
            'carbonmark',
            'protocol-metrics',
            'vesting',
            'user-carbon',
            'pairs',
            'celo-bridged-carbon',
            'ethereum-bridged-carbon',
            'polygon-bridged-carbon',
            'polygon-digital-carbon',
          ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history so we have the branch histories

      - name: Fetch base and head branches
        run: |
          # Fetch the base branch and ensure the PR's head commit is available
          git fetch origin ${{ github.base_ref }}  # Fetch the base branch explicitly
          git fetch origin ${{ github.event.pull_request.head.ref }}  # Fetch PR's head commit

          echo "Base branch: ${{ github.base_ref }}"
          echo "PR head branch: ${{ github.event.pull_request.head.ref }}"

      - name: Initialize error log
        run: |
          echo "" > errors.log

      - name: Check for changes in subgraph folder
        id: check_changes
        run: |
          # Compare the base branch with the PR's head commit
          echo "Checking for changes in ${matrix.value}"
          echo "Base branch: origin/${{ github.base_ref }}"
          echo "PR head branch: origin/${{ github.event.pull_request.head.ref }}"

          CHANGED=$(git diff --name-only origin/${{ github.base_ref }} origin/${{ github.event.pull_request.head.ref }} -- | grep "^${{ matrix.value }}/" || true)
          if [ -n "$CHANGED" ]; then
            echo "changes=true" >> $GITHUB_ENV
          else
            echo "changes=false" >> $GITHUB_ENV
          fi

      - name: Check version update if changes exist
        if: env.changes == 'true'
        run: |
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:${{ matrix.value }}/package.json | grep '"version":' | cut -d'"' -f4)
          PR_VERSION=$(git show origin/${{ github.event.pull_request.head.ref }}:${{ matrix.value }}/package.json | grep '"version":' | cut -d'"' -f4)

          if [ "$BASE_VERSION" = "$PR_VERSION" ]; then
            echo "Error: Version in package.json for ${{ matrix.value }} has not been updated." >> errors.log
            echo "Base version: $BASE_VERSION" >> errors.log
            echo "PR version: $PR_VERSION" >> errors.log
          else
            echo "Version has been updated for ${{ matrix.value }}."
            echo "Base version: $BASE_VERSION"
            echo "PR version: $PR_VERSION"
          fi

      - name: Final version check summary
        if: env.changes == 'true'
        run: |
          if [ -s errors.log ]; then
            cat errors.log
            exit 1
          else
            echo "All subgraphs have been successfully updated."
          fi
