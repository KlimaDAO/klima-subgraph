name: Check Version Update

on: 
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  check-version-update:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        value:
          [
            'bonds',
            'carbonmark',
            'protocol-metrics',
            'vesting',
            'user-carbon',
            'pairs',
            'celo-bridged-carbon',
            'ethereum-bridged-carbon',
            'polygon-bridged-carbon',
            'polygon-digital-carbon',
          ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch the full history

      - name: Determine if it's a PR or a push
        id: event_type
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "is_pr=true" >> $GITHUB_ENV
          else
            echo "is_pr=false" >> $GITHUB_ENV
          fi

      - name: Fetch base and head branches for PRs
        if: env.is_pr == 'true'
        run: |
          # Fetch the base branch
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

          # Fetch the PR's head branch
          git fetch origin ${{ github.event.pull_request.head.ref }}:${{ github.event.pull_request.head.ref }}

      - name: Fetch base branch for pushes
        if: env.is_pr == 'false'
        run: |
          # Fetch the default branch (e.g., main or master) for pushes
          git fetch origin main:main

      - name: Initialize error log
        run: |
          echo "" > errors.log

      - name: Check for changes in subgraph folder
        id: check_changes
        run: |
          echo "Checking for changes in ${{ matrix.value }}"

          if [[ "${{ env.is_pr }}" == "true" ]]; then
            # Compare the base branch with the PR's head branch (for pull requests)
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }} origin/${{ github.event.pull_request.head.ref }} -- "${{ matrix.value }}/" || true)
          else
            # Compare the current branch with the default branch (for pushes)
            CHANGED=$(git diff --name-only origin/main ${{ github.sha }} -- "${{ matrix.value }}/" || true)
          fi

          if [ -n "$CHANGED" ]; then
            echo "changes=true" >> $GITHUB_ENV
          else
            echo "changes=false" >> $GITHUB_ENV
          fi

      - name: Check version update if changes exist
        if: env.changes == 'true'
        run: |
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:${{ matrix.value }}/package.json | grep '"version":' | cut -d'"' -f4)
          PR_VERSION=$(git show ${{ github.sha }}:${{ matrix.value }}/package.json | grep '"version":' | cut -d'"' -f4)

          if [ "$BASE_VERSION" = "$PR_VERSION" ]; then
            echo "Error: Version in package.json for ${{ matrix.value }} has not been updated." >> errors.log
            echo "Base version: $BASE_VERSION" >> errors.log
            echo "PR version: $PR_VERSION" >> errors.log
          else
            echo "Version has been updated for ${{ matrix.value }}."
            echo "Base version: $BASE_VERSION"
            echo "PR version: $PR_VERSION"
          fi

      - name: Final version check summary
        if: env.changes == 'true'
        run: |
          if [ -s errors.log ]; then
            cat errors.log
            exit 1
          else
            echo "All subgraphs have been successfully updated."
          fi
